# All the Layers Working in Unison

## End-to-end web request (Computer 1 → Computer 2)

**Definition:** A full network communication requires every layer (Physical → Data Link → Network → Transport → Application) to work together to deliver a TCP segment from a client to a server.

**Example:** Computer 1 (10.1.1.100) opens a browser to reach Computer 2 (172.16.1.100:80) across Router A and Router B.

---

## Phase 1: The Local Decision (Computer 1)

When the user enters an IP into a browser, the OS networking stack performs a logical comparison.

**Subnet Check:** Computer 1 compares its IP (10.1.1.100) and subnet (/24) to the destination (172.16.1.100). Since they do not match, it realizes the packet must go to the Default Gateway (10.1.1.1).

**ARP Discovery:** Computer 1 broadcasts an ARP Request to find the MAC address of the gateway. Router A responds with its hardware address.

**Socket Creation:** The OS opens a socket using an Ephemeral Port (e.g., 50,000) to represent the web browser's end of the connection.

### Images (Phase 1)

![Phase 1 - Topology / Target](M-03-01-Topology-Target.jpg)
![Phase 1 - ARP Request Broadcast](M-03-02-ARP-Request-Broadcast.jpg)
![Phase 1 - ARP Reply / MAC Learned](M-03-03-ARP-Reply-MAC-Learned.jpg)
![Phase 1 - Connection Starting](M-03-04-Connection-Starting.jpg)

---

## Phase 2: Encapsulation (Layer by Layer)

Before the data hits the wire, it is wrapped in headers at each layer of the stack:

**Transport (TCP):** A segment is created with Source Port 50,000, Destination Port 80, and the SYN flag set.

**Network (IP):** The segment is placed in a datagram with Source IP 10.1.1.100, Destination IP 172.16.1.100, and a TTL of 64.

**Data Link (Ethernet):** The datagram is placed in a frame with Computer 1's MAC as source and Router A's MAC as the destination.

### Images (Phase 2)

![Phase 2 - TCP Datagram](M-03-05-TCP-Datagram.jpg)
![Phase 2 - IP Datagram](M-03-06-IP-Datagram.jpg)
![Phase 2 - Encapsulation (IP + TCP)](M-03-07-Encapsulation-IP-TCP.jpg)
![Phase 2 - Ethernet Datagram](M-03-08-Ethernet-Datagram.jpg)
![Phase 2 - Ethernet + IP + TCP Ready](M-03-09-Ethernet-IP-TCP-Ready.jpg)

---

## Phase 3: Routing and the Hop (Router A to Router B)

Routers act as the middlemen that bridge different networks.

**De-encapsulation:** Router A receives the frame, verifies the checksum, and strips the Ethernet header to look at the IP datagram.

**Routing Table Lookup:** It sees the destination 172.16.1.0/24 is reachable via Router B (192.168.1.1).

**TTL Decrement:** The router reduces the Time To Live (TTL) by 1 and recalculates the checksum.

**Re-encapsulation:** Router A creates a new Ethernet frame using Router B's MAC address as the destination.

### Images (Phase 3)

![Phase 3 - Packet Leaving Computer 1](M-03-10-Packet-Leaving-Computer 1.jpg)
![Phase 3 - Packet Arrives at Router A](assets/frame-12.jpg)
![Phase 3 - Router A Processing IP Datagram](M-03-11-Packet-Arrives-at-Router-A.jpg)
![Phase 3 - TTL Decrement / Checksum Update](M-03-12-TTL-Decrement-Checksum-Update.jpg)
![Phase 3 - TTL Decrement / Checksum Update](M-03-13-TTL-Decrement-Checksum-Update.jpg)
![Phase 3 - TTL Decrement / Checksum Update](M-03-14-TTL-Decrement-Checksum-Update.jpg)
![Phase 3 - New Ethernet Frame to Router B](M-03-15-New-Ethernet-Frame-to-Router-B.jpg)

---

## Phase 4: Delivery and Hand-off (Computer 2)

**Arrival:** Router B repeats the process, identifying that 172.16.1.100 is on its local interface (Network C), and sends the frame to Computer 2.

**Verification:** Computer 2 verifies all checksums (Ethernet, IP, and TCP).

**The Socket Match:** The networking stack identifies Port 80. It finds an active socket in the LISTEN state (held by the Apache web server).

**State Change:** Computer 2 records the sequence number from the SYN packet to prepare its response (SYN-ACK).

### Images (Phase 4)

![Phase 4 - Router B Builds Ethernet Frame to Computer 2](M-03-16a-Router-B-Builds-Ethernet-Frame-to-Computer-2.jpg)
![Phase 4 - Router B Builds Ethernet Frame to Computer 2](M-03-16b-Router-B-Builds-Ethernet-Frame-to-Computer-2.jpg)
![Phase 4 - Packet Delivered to Computer 2](M-03-17a-Packet-Delivered-to-Computer-2.jpg)
![Phase 4 - Packet Delivered to Computer 2](M-03-17b-Packet-Delivered-to-Computer-2.jpg)
![Phase 4 - TCP Segment Checksum Verified](M-03-18a-TCP-Segment-Checksum-Verified.jpg)
![Phase 4 - TCP Segment Checksum Verified](M-03-18b-TCP-Segment-Checksum-Verified.jpg)
![Phase 4 - TCP Sequence Number Recorded](M-03-19a-TCP-Sequence-Number-Recorded.jpg)
![Phase 4 - TCP Sequence Number Recorded](M-03-19b-TCP-Sequence-Number-Recorded.jpg)
![Phase 4 - TCP Sequence Number Recorded](M-03-20-Router-B-to-Computer-2-Delivery.jpg)
![Phase 4 - TCP Sequence Number Recorded](M-03-21-TCP-Checksum-Validation.jpg)
![Phase 4 - TCP Sequence Number Recorded](M-03-22-TCP-Sequence-Number-Tracking.jpg)
![Phase 4 - TCP Sequence Number Recorded](M-03-23-TCP-SYN-Arrives-at-Server.jpg)

---

## Professional Troubleshooting Insight

This scenario highlights why pinging is so useful. If user ping Computer 2 from Computer 1, you know that Layers 1-3 (Physical, Data Link, and Network) and all the routing hops in between are functional.

If the web page still will not load, user can focus specifically to Layer 4 (Port 80 blocked by a firewall) or Layer 7 (The Apache service is crashed).

---

## Where:

### Default gateway routing

**Definition:** If the destination IP is outside the local subnet, the computer sends traffic to its default gateway for routing to other networks.

**Example:** Computer 1 sees 172.16.1.100 is not in 10.1.1.0/24, so it forwards the packet to gateway 10.1.1.1.

### ARP (Address Resolution Protocol)

**Definition:** ARP maps a local IP address to a MAC address so Ethernet frames can be delivered on the local network.

**Example:** Computer 1 broadcasts an ARP request for 10.1.1.1 and Router A replies with MAC 00:11:22:33:44:55.

### Ephemeral port + socket (client side)

**Definition:** The OS selects a temporary high-numbered port (ephemeral port) and opens a socket so the client application can establish a TCP connection.

**Example:** Computer 1 selects ephemeral port 50,000 and opens a socket for the web browser.

### TCP SYN segment (connection start)

**Definition:** TCP begins a connection by sending a SYN segment with source/destination ports, sequence number, and checksum.

**Example:** Computer 1 sends TCP SYN from port 50,000 to destination port 80.

### IP datagram creation (Network layer encapsulation)

**Definition:** The IP layer wraps the TCP segment inside an IP header containing source IP, destination IP, and TTL.

**Example:** IP header includes source 10.1.1.100, destination 172.16.1.100, TTL 64.

### Ethernet frame creation (Data Link encapsulation)

**Definition:** Ethernet wraps the IP datagram into a frame using source and destination MAC addresses for delivery on the local link.

**Example:** Destination MAC is Router A’s MAC 00:11:22:33:44:55 so the frame reaches the gateway.

### Switch forwarding (Layer 2 delivery)

**Definition:** A switch forwards frames based on the destination MAC address to the correct port.

**Example:** The switch sends the frame only to the interface connected to Router A.

### Router processing (decapsulation + routing decision)

**Definition:** Routers remove the Ethernet frame, inspect the IP header, validate checksums, and forward the packet toward the destination network.

**Example:** Router A strips Ethernet, checks IP, and routes toward 172.16.1.0/24 via Router B (192.168.1.1).

### TTL decrement + checksum update

**Definition:** Each router reduces the IP TTL by 1 and recalculates the IP header checksum before forwarding.

**Example:** Router A decrements TTL (64 → 63), Router B decrements again (63 → 62).

### Re-encapsulation at each hop

**Definition:** Every time a packet crosses into a new network segment, it is placed into a new Ethernet frame with new source/destination MAC addresses.

**Example:** Router A builds a new frame on Network B to Router B; Router B builds a new frame on Network C to Computer 2.

### Server port listening (destination socket)

**Definition:** The server delivers TCP traffic to the correct application by checking if a socket is listening on the destination port.

**Example:** Computer 2 receives destination port 80 and confirms Apache is listening in the LISTEN state.

### TCP connection handshake repetition across the path

**Definition:** Every step of encapsulation, switching, routing, and checksum validation happens again for SYN/ACK and ACK packets during the handshake.

**Example:** SYN travels to Computer 2, then SYN/ACK travels back to Computer 1, then ACK travels again to Computer 2.

